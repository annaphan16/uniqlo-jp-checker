name: Build Uniqlo JP Checker EXE

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag for the release (e.g., v1.0.0)'
        required: false
        default: 'dev'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Install Playwright browsers
        run: |
          playwright install firefox
          playwright install-deps firefox

      - name: Install Camoufox browser
        run: |
          python -c "from camoufox.sync_api import Camoufox; print('Camoufox imported successfully')"
          python -m camoufox fetch
        continue-on-error: true

      - name: Create PyInstaller spec file
        run: |
          @"
          # -*- mode: python ; coding: utf-8 -*-
          import os
          import sys
          from PyInstaller.utils.hooks import collect_all, collect_data_files, collect_submodules

          block_cipher = None

          # Collect all data and binaries from packages
          datas = []
          binaries = []
          hiddenimports = []

          # Collect camoufox data
          try:
              camoufox_datas, camoufox_binaries, camoufox_hiddenimports = collect_all('camoufox')
              datas += camoufox_datas
              binaries += camoufox_binaries
              hiddenimports += camoufox_hiddenimports
          except Exception as e:
              print(f"Warning: Could not collect camoufox: {e}")

          # Collect playwright data
          try:
              playwright_datas, playwright_binaries, playwright_hiddenimports = collect_all('playwright')
              datas += playwright_datas
              binaries += playwright_binaries
              hiddenimports += playwright_hiddenimports
          except Exception as e:
              print(f"Warning: Could not collect playwright: {e}")

          # Add colorama
          try:
              colorama_datas = collect_data_files('colorama')
              datas += colorama_datas
              hiddenimports += collect_submodules('colorama')
          except Exception as e:
              print(f"Warning: Could not collect colorama: {e}")

          # Add additional hidden imports
          hiddenimports += [
              'asyncio',
              'json',
              'datetime',
              'threading',
              'concurrent.futures',
              'platform',
              'requests',
              'urllib3',
              'certifi',
              'charset_normalizer',
              'idna',
          ]

          # Add data files from current directory
          datas += [
              ('config.json', '.'),
              ('acc.txt', '.'),
              ('proxy.txt', '.'),
          ]

          a = Analysis(
              ['uniqlo_jp_checker_camoufox.py'],
              pathex=[],
              binaries=binaries,
              datas=datas,
              hiddenimports=hiddenimports,
              hookspath=[],
              hooksconfig={},
              runtime_hooks=[],
              excludes=[],
              win_no_prefer_redirects=False,
              win_private_assemblies=False,
              cipher=block_cipher,
              noarchive=False,
          )

          pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

          exe = EXE(
              pyz,
              a.scripts,
              a.binaries,
              a.zipfiles,
              a.datas,
              [],
              name='UniqloJPChecker',
              debug=False,
              bootloader_ignore_signals=False,
              strip=False,
              upx=True,
              upx_exclude=[],
              runtime_tmpdir=None,
              console=True,
              disable_windowed_traceback=False,
              argv_emulation=False,
              target_arch=None,
              codesign_identity=None,
              entitlements_file=None,
              icon=None,
          )
          "@ | Out-File -FilePath uniqlo_checker.spec -Encoding utf8

      - name: Build EXE with PyInstaller
        run: |
          pyinstaller uniqlo_checker.spec --clean

      - name: Create distribution package
        run: |
          New-Item -ItemType Directory -Force -Path dist/UniqloJPChecker
          Copy-Item dist/UniqloJPChecker.exe dist/UniqloJPChecker/
          Copy-Item config.json dist/UniqloJPChecker/
          Copy-Item acc.txt dist/UniqloJPChecker/ -ErrorAction SilentlyContinue
          Copy-Item proxy.txt dist/UniqloJPChecker/ -ErrorAction SilentlyContinue
          Copy-Item README.md dist/UniqloJPChecker/ -ErrorAction SilentlyContinue
          Copy-Item QUICKSTART.md dist/UniqloJPChecker/ -ErrorAction SilentlyContinue
          
          # Create empty files if they don't exist
          if (-not (Test-Path dist/UniqloJPChecker/acc.txt)) {
            New-Item -ItemType File -Path dist/UniqloJPChecker/acc.txt
          }
          if (-not (Test-Path dist/UniqloJPChecker/proxy.txt)) {
            New-Item -ItemType File -Path dist/UniqloJPChecker/proxy.txt
          }

      - name: Create ZIP archive
        run: |
          Compress-Archive -Path dist/UniqloJPChecker/* -DestinationPath dist/UniqloJPChecker-Windows-x64.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: UniqloJPChecker-Windows-x64
          path: dist/UniqloJPChecker-Windows-x64.zip
          retention-days: 30

      - name: Create Release (on tag push)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/UniqloJPChecker-Windows-x64.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows-onedir:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Install Playwright browsers
        run: |
          playwright install firefox
          playwright install-deps firefox

      - name: Install Camoufox browser
        run: |
          python -c "from camoufox.sync_api import Camoufox; print('Camoufox imported successfully')"
          python -m camoufox fetch
        continue-on-error: true

      - name: Build EXE (onedir mode - smaller size)
        run: |
          pyinstaller --name UniqloJPChecker `
            --onedir `
            --console `
            --add-data "config.json;." `
            --add-data "camoufox_cookie_getter.py;." `
            --hidden-import camoufox `
            --hidden-import camoufox.sync_api `
            --hidden-import camoufox.async_api `
            --hidden-import playwright `
            --hidden-import playwright.sync_api `
            --hidden-import playwright.async_api `
            --hidden-import colorama `
            --hidden-import requests `
            --hidden-import asyncio `
            --hidden-import json `
            --hidden-import datetime `
            --hidden-import threading `
            --hidden-import concurrent.futures `
            --collect-all camoufox `
            --collect-all playwright `
            --collect-data colorama `
            uniqlo_jp_checker_camoufox.py

      - name: Prepare distribution
        run: |
          Copy-Item config.json dist/UniqloJPChecker/
          Copy-Item acc.txt dist/UniqloJPChecker/ -ErrorAction SilentlyContinue
          Copy-Item proxy.txt dist/UniqloJPChecker/ -ErrorAction SilentlyContinue
          Copy-Item README.md dist/UniqloJPChecker/ -ErrorAction SilentlyContinue
          Copy-Item QUICKSTART.md dist/UniqloJPChecker/ -ErrorAction SilentlyContinue
          
          # Create empty files if they don't exist
          if (-not (Test-Path dist/UniqloJPChecker/acc.txt)) {
            New-Item -ItemType File -Path dist/UniqloJPChecker/acc.txt
          }
          if (-not (Test-Path dist/UniqloJPChecker/proxy.txt)) {
            New-Item -ItemType File -Path dist/UniqloJPChecker/proxy.txt
          }

      - name: Create ZIP archive
        run: |
          Compress-Archive -Path dist/UniqloJPChecker/* -DestinationPath dist/UniqloJPChecker-Windows-x64-onedir.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: UniqloJPChecker-Windows-x64-onedir
          path: dist/UniqloJPChecker-Windows-x64-onedir.zip
          retention-days: 30

      - name: Create Release (on tag push)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/UniqloJPChecker-Windows-x64-onedir.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

